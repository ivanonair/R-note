---
title: "R 機率預測評估方法"
author: "Ivan Lin"
date: "2020年4月23日"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---
```{r setup, include=FALSE}
#這段並不會show出來
knitr::opts_chunk$set(echo = TRUE)
require(kableExtra)
require(car)
require(tidyverse)
require(prettydoc)
require(Metrics)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html") 
```

在前一篇[數值預估評估方法]()，已介紹我們進行數值預測時，怎麼評估模型的好壞，在這篇，我們來介紹機率預測模型的評估方法。

前情提要

## 模型評估-驗證指標(validation index)

若將預測這件事簡單區分成兩大種類，大致可分為<br>
1. 機率預測，比如會不會下雨、下一張牌的紅心A...<br>
2. 數值預測，比如預測下一季的銷售量、捷運站的客流量...<br>
我們利用所蒐集到的資料訓練出模型進行預測，然而怎麼評估模型成效(Performance)呢？<br>

我們會使用驗證指標(validation index)來當作成效參考，對應到機器學習領域，依據應用分為「分類指標」和「回歸指標」。

**機率預測的「分類指標」**:   <br>
    - 二元相關：混淆矩陣confusion matrix和相對應驗證指標、ROC曲線、AUC。<br>
    - 多元相關：多元混淆矩陣和相對應驗證指標。<br>

**數值預測的「回歸指標」**:   <br>
    - 絕對誤差(Absolute Error, E)、相對誤差(Relative Error, e) <br>
    - 平均絕對誤差(Mean Absolute Error, MAE) <br>
    - 平均均方誤差(Mean Squared Error, MSE) <br>
    - 平均均方對數誤差(Mean Squared Logarithmic Error, MSLE) <br>
    - 正歸化均方誤差、均方根誤差 <br>

## 二元機率預測
本篇先從簡單的二元預測開始，甚麼是二元預測呢？舉例來說就是答案非正即負，例如：發生或不發生；正面或反面；A類或B類；下雨或不下雨，兩種情況的預測。記得以前研究所時，我們的專題是將山坡地切割成數公尺方形網格，利用機率預測判斷這個網格是否有可能山崩，這也是一種二元的機率預測。<br>

複習一下統計學，機率是指事情出現的可能性，是對分類問題中某種類別出現的機率的描述。

## 混淆矩陣

混淆矩陣是最廣泛且最基本用來評估分類模型的方式，這邊舉例講解會較清楚。<br>
假設有間醫院有500個疑似流感患者的病人做篩檢，其中實際有得到流感的人數是150人，未得到的是350人，然而醫院使用快篩法解省時間成本，但快篩法的結果是得到流感的有155人，未得到的有345人，其中包含有得到卻錯誤被篩為未得病的偽陰性15人，還有明明沒有流感卻被誤判為陽性的20人。這樣敘述是不是讓人覺得很冗長也難理解呢？若我們做成誤差矩陣就一目了然！<br>
![誤差矩陣範例](.\pics\confusion matrix example.png)
<br>
對角線黃色區塊，代表快篩結果判斷正確的人數，另一邊未填色的則是快篩判斷錯誤的人數。<br>
從圖上我們可以計算各種佔比變且轉化成機率表示，例如有得病卻篩檢錯誤的機率15/150=10%...<br>

接下來我們就來介紹各種誤差矩陣算出來的各種數值！
![誤差矩陣](.\pics\confusion matrix.png)

我們從左上角順時鐘介紹：<br>
當一個正類的資料點被預測為正值，即為真正類（ True positive, TP），如圖左上；<br>
當一個負類的資料點被預測為正值，即為偽正類（False positive, FP），如圖右上；<br>
當一個負類的資料點被預測為負值，即為真負類（ True negative, TN），如圖右下；<br>
當一個正類的資料點被預測為負值，即為偽負類（False negative, FN），如圖左下。<br>

直覺上，TP與TN可能比較是被關注的點。因為如果模型有很好的TP和TN值，就表示模型預測的正確性很高。<br>
但對於我們在訓練模型時，更在意FP和FN，因為專注於改善錯誤，更有助於調整模型。

FP和FN又被稱為一型錯誤(ɑ錯誤)和二型錯誤(β錯誤)。<br>
一型錯誤指的是感興趣的目標未被發現；二型反過來，是被發現的目標壓根不是需要被關注的對象。

透過混淆矩陣，我們很方便計算以下評估指標：<br>

這些指標在統計學與機器學習有不同的慣用翻譯，以下介紹採用ML領域常見的用法，並盡我所知的補充。

***

## 總體比率：
### 總體準確率(Accuracy, Acc)
模型總體的準確率，有被正確預測的數量佔總體的比值，這個比值當然希望越高越好！<br>
\[Acc=\frac{TP+TN}{TP+TN+FP+FN}\]
利用上述流感的例子，\(TA=(135+330)/500=0.93\)

### 總體錯誤率(Total Error Rate, TER)
指模型總體預測錯誤的比率，與總體準確率Accrucy和為1。
\[TER=\frac{FP+FN}{T}=1-Acc\]
流感例子為\(TER=(20+15)/500=0.07\)

***

## 佔預測分類的邊際機率：
以預測為正或預測為負總數當作分母

### 精準度(Percision)
又稱為正元符合率，陽性預測值Positive predictive value(PPV)，指模型中正確預測正樣本的數量佔預測為正數量的比值，是經常被用到的指標。
\[Percision=\frac{TP}{TP+FP}\]
流感例子的\(P=135/155=0.87\)

### 負元精準度；陰性預測值(Negative predictive value, NPV)
又稱為負元符合率，指模型中正確預測負樣本的數量佔預測為負數量的比值。
\[NPV=\frac{TN}{TN+FN}\]
流感例子的\(P=135/155=0.87\)

### 錯誤率(False Discovery Rate, FDR)
指模型錯誤地預測正樣本(稱為：型一錯誤)偽陽性的數量佔預測為正樣本的數量比值。對比於精準度(Percision)
\[FDR=\frac{FP}{TP+FP}\]
流感例子為\(FDR=20/155=0.13\)

### 負元錯誤率(False Omission Rate, FOR)
指模型錯誤地預測負樣本(稱為：型一錯誤)偽陰性的數量佔預測為負樣本的數量比值。
\[FDR=\frac{FN}{TN+FN}\]
流感例子為\(FOR=135/150=0.9\)

***
## 佔實際分類的邊際機率：
以實際為正或實際為負總數當作分母

### 召回率(Recall)
又稱為真正率(True Positive Rate, TPR)、覆蓋率(Coverage Rate, CR)、靈敏度(Sensitivity)、查全率、擊中率或命中率。<br>
它表示模型中被正確預測為正的樣本佔全體正樣本的比值，對於一些重要的事件預測，比如說疾病，這些關注的事件能不能有效被模型分類很重要。
\[Recall=\frac{TP}{TP+FN}\]
流感例子的\(Recall=135/150=0.9\)
若把流感改為最近影響世界的武漢肺炎，十個染病帶源者接受篩選，會有一個被誤判為陰性，雖然召回率高達九成，但那一成偽陰性誤判結果對防疫仍是很難接受的。

### 特異性(Specficity)
又稱為真負率(True Negative Rate, TNR)、負元覆蓋率(Negative Coverage Rate, NCR)、負元召回率、負元查全性。<br>
它表示模型中被正確預測為負樣本佔全體負樣本的比值。
\[Specficity=\frac{TN}{FP+TN}\]
流感例子的\(Specficity=330/350=0.94\)

### 假正率 FPR 
又稱為錯正率、虛報率、誤報率，是指模型錯誤地預測正樣本的數量佔實際負樣本的比值，對於模型而言，將預測為正的門檻下拉，導致整體預測為整的比例變多，可能能降低FN，卻回同時推升FP，這之間的平衡取捨則看模型的目的。
\[FPR=\frac{TN}{FP+TN}\]
流感例子的\(FPR=20/(20+330)=0.06\)

### 假負率 FNR
又稱為錯負率、漏報率，是指模型錯誤地預測負樣本的數量佔實際正樣本的比值，跟召回率也互相對應。
\[FNR=\frac{TN}{FP+TN}\]
流感例子的\(FNR=15/(15+135)=0.1\)



這裡引用網路上 [Tommy大神](https://medium.com/@chih.sheng.huang821/%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92-%E7%B5%B1%E8%A8%88%E6%96%B9%E6%B3%95-%E6%A8%A1%E5%9E%8B%E8%A9%95%E4%BC%B0-%E9%A9%97%E8%AD%89%E6%8C%87%E6%A8%99-b03825ff0814)整理的指標計算表![指標計算表](.\pics\Index of confusion matrix.png)<br>
非常強大！

從這張圖可以很容易計算邊際機率，並能了解各參數彼此消長的情況。

***
透過上述的值，我們還可以進一步推算指標


## 多元誤差矩陣
上面介紹了二元誤差矩陣，然而如果是分類問題，結果可能有多種(m種)分類，例如動物依特徵被分類成貓、狗、兔子...，這種情況多元矩陣仍然適用。總共的分類結果有M*M種，其中正確被分類的有M種，錯誤的會有M^2-M種。
